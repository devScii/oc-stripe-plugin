{% if not __SELF__.pub_key %}
  <div>
    <h2>{{ "A Stripe publishable key MUST be defined in the plugin settings"}}</h2>
  </div>
{% else %}
  {% put scripts %}
  <script>
    var checkout = StripeCheckout.configure({
      key: "{{ __SELF__.pub_key }}",
      image: "{{ __SELF__.logo }}",
      locale: "{{ __SELF__.locale }}",
      currency: "{{ __SELF__.currency }}",
      token: function(results) {
        $.request('{{ __SELF__ }}::onStripeCallback', {
            data: {'stripeData': results, 'invoiceData': get_order_data(), 'redirect': $('#redirect_url').val() },
        });
      }
    });

    $('#stripe_checkout').click(function(e) {
      order_data = get_order_data();
      checkout.open({
        name: "{{ app_name | default(__SELF__.app_name) }}",
        amount: order_data.amount * 100,
        description: order_data.description,
      });
      e.preventDefault();
    });

    function get_order_data() {
      return {'amount': $('#order_amount').val(), 'description': $('#order_description').val()}
    }

    window.addEventListener('popstate', function() {
      checkout.close();
    });
  </script>
  {% endput %}
{% endif %}
