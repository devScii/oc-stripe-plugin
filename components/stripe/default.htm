{% if __SELF__.pub_key %}
<form>
  <button id="stripe_checkout">{{ submit_label | default('studioazura.stripe::lang.form.submit_label'|trans) }}</button>
  {% put scripts %}
  <script>
    var redirect_url = "{{ redirect_url | default('/') }}";
    var checkout = StripeCheckout.configure({
      key: "{{ __SELF__.pub_key }}",
      image: "{{ __SELF__.logo }}",
      locale: "{{ __SELF__.locale }}",
      currency: "{{ __SELF__.currency }}",
      token: function(results) {
        var invoice = {
            'amount': {{ order_amount }},
            'description': "{{ order_description | default('') }}",
        };
        return $.request('{{ __SELF__ }}::onStripeCallback', {
            data: {'stripeData': results, 'invoiceData': invoice, 'redirect': redirect_url },
            flash: true,
            handleFlashMessage: function(message, type) {
                $.oc.flashMsg({ text: message, class: type })
            },
        });
      }
    });

    document.getElementById('stripe_checkout').addEventListener('click', function(e) {
      checkout.open({
        name: "{{ app_name | default(__SELF__.app_name) }}",
        description: "{{ order_description | default('') }}",
        amount: {{ order_amount * 100 }},
      });
      e.preventDefault();
    });

    window.addEventListener('popstate', function() {
      checkout.close();
    });
  </script>
  {% endput %}
</form>

{% else %}
<div>
  <h2>{{ "A Stripe publishable key MUST be defined in the plugin settings"}}</h2>
</div>
{% endif %}
